const CACHE_NAME = 'mensajeros-v2';

self.addEventListener('install', (event) => {
	self.skipWaiting();
});

self.addEventListener('activate', (event) => {
	event.waitUntil(
		caches.keys().then((names) =>
			Promise.all(
				names.filter((n) => n !== CACHE_NAME).map((n) => caches.delete(n))
			)
		)
	);
	self.clients.claim();
});

self.addEventListener('fetch', (event) => {
	if (event.request.method !== 'GET') return;

	event.respondWith(
		fetch(event.request)
			.then((response) => {
				const clone = response.clone();
				caches.open(CACHE_NAME).then((cache) => cache.put(event.request, clone));
				return response;
			})
			.catch(() =>
				caches.match(event.request).then((cached) => {
					if (cached) return cached;
					// Para navegación, devolver la página principal cacheada
					if (event.request.mode === 'navigate') {
						return caches.match('/') || caches.match('/index.html');
					}
					return cached;
				})
			)
	);
});
